(window.webpackJsonp=window.webpackJsonp||[]).push([[20],{586:function(s,t,a){"use strict";a.r(t);var n=a(17),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("ol",[a("li",[a("p",[s._v("webpack-dev-server 的作用")]),s._v(" "),a("ul",[a("li",[s._v("在 webpack 打包入口注入热更新相关文件，一是 websocket 初始化相关逻辑，二是处理热更新的相关逻辑。")]),s._v(" "),a("li",[s._v("注入 HotModuleReplacementPlugin 插件")]),s._v(" "),a("li",[s._v("初始化各种中间件，比如 webpack-dev-middleware、静态资源中间件")]),s._v(" "),a("li",[s._v("初始化 http 服务、初始化 websocket 服务")])])]),s._v(" "),a("li",[a("p",[s._v("webpack-dev-middleware 的作用")]),s._v(" "),a("ul",[a("li",[s._v("以监听模式启动 webpack，并且把打包的结果写到内存中，当有请求进来的时候，从内存中返回内容")])])]),s._v(" "),a("li",[a("p",[s._v("webpack-hot-middleware 容易混淆的中间件又是什么")]),s._v(" "),a("ul",[a("li",[s._v("当我们不使用 webpack-dev-server 启动，比如定制化服务端逻辑的场景，就可以使用这个中间件帮我们实现热更新的功能。这个中间件和 webpack-dev-server 功能类似，在 webpack 编译完后，通知客户端处理。但是使用的不是 websocket，而是 SSE。客户端入口文件、HotModuleReplacementPlugin 插件也需要我们手动配置。")])])]),s._v(" "),a("li",[a("p",[s._v("客户端的逻辑")]),s._v(" "),a("ul",[a("li",[s._v("和 vite 相反，webpack 热更新客户端逻辑会更重。")]),s._v(" "),a("li",[s._v("客户端 websocket 收到更新通知，触发 webpackHotUpdate 事件，交给 webpack 处理")]),s._v(" "),a("li",[s._v("通过上次打包的 hash，拼接 url 请求本次要更新的信息，主要有 chunkId")])]),s._v(" "),a("div",{staticClass:"language-jsx line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-jsx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("http")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3000")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("eb5adff19efc4704908a"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("hot"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("update"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("json\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("ul",[a("li",[s._v("通过上一步拿到的 chunkId，以及上次打包的 hash，拼接 url，去拿真正要更新的内容。上一步是通过 fetch 的方式，但是这次是通过类似 jsonp 的方式，在页面插入 script 标签，通过 script 标签下载")]),s._v(" "),a("li",[s._v("这个 js 脚本下载完后，会自动调用函数，传了三个函数：chunkId，新的模块内容，一个运行时函数，记录本次的 hash，下次热更就可以拿到。")])]),s._v(" "),a("div",{staticClass:"language-jsx line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-jsx"}},[a("code",[s._v("self"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'webpackHotUpdate'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'app'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/***/")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'./src/print.js'")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/*!**********************!*\\\n  !*** ./src/print.js ***!\n  \\**********************/")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/***/")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[s._v("module")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("printMe")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n          console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Updating print.js.28'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n        module"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("exports "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" printMe\n\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/***/")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/******/")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[s._v("__webpack_require__")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// webpackRuntimeModules")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/******/")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'use strict'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/* webpack/runtime/getFullHash */")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/******/")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/******/")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/******/")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/******/")]),s._v(" __webpack_require__"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[s._v("h")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'c3d50da39363caabdfd3'")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/******/")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/******/")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/******/")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br")])]),a("ul",[a("li",[s._v("函数调用后，会记录一下这些信息，然后把之前用于等待下载的 promise resolve 掉。最后去 apply 这些 module")]),s._v(" "),a("li",[s._v("apply 的关键函数 applyHandler，大概逻辑就是返回 dispose 和最终 apply 逻辑，最终的 apply 就是删除模块缓存，进行模块替换，替换完后，执行 accept 定义的回调，如下，下一次 require 或者 import 拿到的内容就是更新后的")])]),s._v(" "),a("div",{staticClass:"language-jsx line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-jsx"}},[a("code",[s._v("module"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("hot"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("?.")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("accept")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'./print.js'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" render"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("ul",[a("li",[s._v("apply 里面还有一个很关键的逻辑，寻找更新边界 getAffectedModuleEffects ,如果发现该模块或者父级都没有 module.hot?.accept，那么会抛出一个错误，最后直接 reload")]),s._v(" "),a("li",[s._v("寻找更新边界的关键点在于维护模块的父子关系，这个关系是在模块 require 其他模块的时候维护的，webpack 重写了 require 逻辑。通过父子关系，就可以一直往上冒泡查找是否有父级模块接受了更新，并且可以拿到回调函数。")])])]),s._v(" "),a("li",[a("p",[s._v("以上是 webpack 热更的逻辑，在我们平时的框架中，类似 vue，会通过 vue-loader 给 hot.accept 注入相关的回调，实现组件级别的热更新。")])])])])}),[],!1,null,null,null);t.default=e.exports}}]);